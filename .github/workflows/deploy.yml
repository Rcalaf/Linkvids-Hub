name: Deploy Direct (No Docker Hub)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout Code
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. Build Server Image
      - name: Build Server Docker Image
        run: |
          docker build -t linkvids-server:latest ./server
      
      - name: Create Env File
        env:
          VAL_DATABASE_URI: ${{ secrets.DATABASE_URI }}
          VAL_ACCESS_TOKEN: ${{ secrets.ACCESS_TOKEN_SECRET }}
          VAL_REFRESH_TOKEN: ${{ secrets.REFRESH_TOKEN_SECRET }}
          VAL_CLIENT_URL: ${{ secrets.CLIENT_URL }}
          VAL_OVH_ENDPOINT: ${{ secrets.OVH_ENDPOINT }}
          VAL_OVH_REGION: ${{ secrets.OVH_REGION }}
          VAL_OVH_BUCKET: ${{ secrets.OVH_BUCKET_NAME }}
          VAL_OVH_ACCESS: ${{ secrets.OVH_ACCESS_KEY }}
          VAL_OVH_SECRET: ${{ secrets.OVH_SECRET_KEY }}
          VAL_EMAIL_USER: ${{ secrets.EMAIL_USER }}
          VAL_EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          VAL_EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
        run: |
          touch .env.production
          echo "NODE_ENV=production" >> .env.production
          echo "PORT=3500" >> .env.production
          echo "DATABASE_URI=$VAL_DATABASE_URI" >> .env.production
          echo "ACCESS_TOKEN_SECRET=$VAL_ACCESS_TOKEN" >> .env.production
          echo "REFRESH_TOKEN_SECRET=$VAL_REFRESH_TOKEN" >> .env.production
          echo "CLIENT_URL=$VAL_CLIENT_URL" >> .env.production
          echo "OVH_ENDPOINT=$VAL_OVH_ENDPOINT" >> .env.production
          echo "OVH_REGION=$VAL_OVH_REGION" >> .env.production
          echo "OVH_BUCKET_NAME=$VAL_OVH_BUCKET" >> .env.production
          echo "OVH_ACCESS_KEY=$VAL_OVH_ACCESS" >> .env.production
          echo "OVH_SECRET_KEY=$VAL_OVH_SECRET" >> .env.production
          echo "EMAIL_USER=$VAL_EMAIL_USER" >> .env.production
          echo "EMAIL_PASS=$VAL_EMAIL_PASS" >> .env.production
          echo "EMAIL_FROM=$VAL_EMAIL_FROM" >> .env.production
      
      # 3. Build Client Image
      - name: Build Client Docker Image
        run: |
          docker build \
          --build-arg VITE_API_URL=https://hub-api.linkvids.io/api \
          -t linkvids-client:latest ./client

      # 4. Save Images to Tarballs (Compressing to save bandwidth)
      - name: Save Docker Images
        run: |
          docker save linkvids-server:latest | gzip > server-image.tar.gz
          docker save linkvids-client:latest | gzip > client-image.tar.gz

      # 5. Copy Files to Server (Images + Compose File)
      - name: Copy Files to Server
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          source: "server-image.tar.gz,client-image.tar.gz,docker-compose.prod.yml,.env.production"
          target: "/home/hub.linkvids"

      # 6. SSH Deploy Command
      - name: Deploy on Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            cd /home/hub.linkvids

            # A. Load the new images from the tarballs
            echo "Loading Server image..."
            gunzip -c server-image.tar.gz | docker load
            echo "Loading Client image..."
            gunzip -c client-image.tar.gz | docker load

            # B. Create .env file from GitHub Secrets (Secure)
            mkdir -p server
            mv .env.production server/.env

            # C. Restart Containers
            # We explicitly tell compose to use the images we just loaded
            docker compose -f docker-compose.prod.yml down
            docker compose -f docker-compose.prod.yml up -d --remove-orphans

            # D. Cleanup to save disk space
            rm -f server-image.tar.gz client-image.tar.gz
            docker image prune -f
