name: Deploy Direct (No Docker Hub)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout Code
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. Build Server Image
      - name: Build Server Docker Image
        run: |
          docker build -t linkvids-server:latest ./server
      
      - name: Create Env File
        run: |
          echo "NODE_ENV=production" > .env.production
          echo "PORT=3500" >> .env.production
          echo "DATABASE_URI=${{ secrets.DATABASE_URI }}" >> .env.production
          echo "ACCESS_TOKEN_SECRET=${{ secrets.ACCESS_TOKEN_SECRET }}" >> .env.production
          echo "REFRESH_TOKEN_SECRET=${{ secrets.REFRESH_TOKEN_SECRET }}" >> .env.production
          echo "CLIENT_URL=${{ secrets.CLIENT_URL }}" >> .env.production
          echo "OVH_ENDPOINT=${{ secrets.OVH_ENDPOINT }}" >> .env.production
          echo "OVH_REGION=${{ secrets.OVH_REGION }}" >> .env.production
          echo "OVH_BUCKET_NAME=${{ secrets.OVH_BUCKET_NAME }}" >> .env.production
          echo "OVH_ACCESS_KEY=${{ secrets.OVH_ACCESS_KEY }}" >> .env.production
          echo "OVH_SECRET_KEY=${{ secrets.OVH_SECRET_KEY }}" >> .env.production
          echo "EMAIL_USER=${{ secrets.EMAIL_USER }}" >> .env.production
          echo "EMAIL_PASS=${{ secrets.EMAIL_PASS }}" >> .env.production
          echo "EMAIL_FROM=${{ secrets.EMAIL_FROM }}" >> .env.production

      # 3. Build Client Image
      - name: Build Client Docker Image
        run: |
          docker build -t linkvids-client:latest ./client

      # 4. Save Images to Tarballs (Compressing to save bandwidth)
      - name: Save Docker Images
        run: |
          docker save linkvids-server:latest | gzip > server-image.tar.gz
          docker save linkvids-client:latest | gzip > client-image.tar.gz

      # 5. Copy Files to Server (Images + Compose File)
      - name: Copy Files to Server
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          source: "server-image.tar.gz,client-image.tar.gz,docker-compose.prod.yml"
          target: "/home/hub.linkvids"

      # 6. SSH Deploy Command
      - name: Deploy on Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            cd /home/hub.linkvids

            # A. Load the new images from the tarballs
            echo "Loading Server image..."
            gunzip -c server-image.tar.gz | docker load
            echo "Loading Client image..."
            gunzip -c client-image.tar.gz | docker load

            # B. Create .env file from GitHub Secrets (Secure)
            mkdir -p server
            echo "${{ secrets.ENV_FILE }}" > server/.env

            # C. Restart Containers
            # We explicitly tell compose to use the images we just loaded
            docker-compose -f docker-compose.prod.yml down
            docker-compose -f docker-compose.prod.yml up -d --remove-orphans

            # D. Cleanup to save disk space
            rm -f server-image.tar.gz client-image.tar.gz
            docker image prune -f
